
import bible from './hebrew_bible_with_nikkud.json';

export const YEHI_RATZON_BEFORE = [
  "יְהִי רָצוֹן מִלְפָנֶיךָ יְיָ אֱלֹהֵינוּ וְאֱלֹהֵי אֲבוֹתֵינוּ, הַבּוֹחֵר בְּדָוִד עַבְדוֹ וּבְזַרְעוֹ אַחֲרָיו, וְהַבּוֹחֵר בְּשִירוֹת וְתִשְבָּחוֹת, שֶׁתֵּפֶן בְּרַחֲמִים אֶל קְרִיאַת מִזְמוֹרֵי תְהִלִּים שֶׁאֶקְרָא, כְּאִלוּ אֳמָרָם דָוִד הַמֶלֶךְ עָלָיו הַשָׁלוֹם בְּעַצְמוֹ, זְכוּתוֹ יָגֵן עָלֵינוּ.",
  "וְיַעֲמוֹד לָנוּ זְכוּת פְּסוּקֵי תְהִלִּים וּזְכוּת תֵבוֹתֵיהֶם וְאוֹתִיוֹתֵיהֶם וּנְקוּדוֹתֵיהֶם וְטַעֲמֵיהֶם, וְהָשֵמוֹת הָיוֹצְאִים מֵהֶם מֵרָאשֵׁי תֵבוֹת וּמִסוֹפֵי תֵבוֹת, לְכַפֵּר חַטֹאתֵינוּ וַעֲווֹנוֹתֵינוּ וּפְשָעֵינוּ, וּלְזַמֵר עָרִיצִים וְלְהַכְרִית כָּל הַחוֹחִים וְהַקוֹצִים הַסוֹבְבִים אֶת הַשׁוֹשַׁנָה הָעֶלְיוֹנָה, וּלְחַבֵּר אֵשֶׁת נְעוּרִים עִם דוֹדָה בְּאַהֲבָה וְאַחֲוָה וְרֵעוּת.",
  "וּמִשָׁם יִמָשֵׁךְ לָנוּ שֶׁפָע לְנֶפֶשׁ רוּחַ וּנְשָׁמָה לְטַהֲרֵנוּ מֵעֲווֹנוֹתֵינוּ וְלִסְלוֹחַ חַטֹאתֵינוּ וּלְכַפֵּר פְּשָׁעֵינוּ, כְּמוֹ שֶׁסָלַחְתָ לְדָוִד שֶׁאָמָר מִזְמוֹרִים אֵלוּ לְפָנֶיךָ, כּמוֹ שֶׁנֶאֱמַר: גַם יְיָ הֶעֱבִיר חַטָאתְךָ לֹא תָמוּת. וְאַל תִקָחֵנוּ מֵהָעוֹלָם הַזֶה קוֹדֶם זְמַנֵנוּ, וְנִזְכֶּה לְחַיִים אֲרוּכִּים טוֹבִים וּמְתוּקָנִים, בְּאוֹפָן שֶׁנוּכַל לְתַקֵן אֶת אֲשֶׁר שִׁיחַתְנוּ.",
  "וּזְכוּת דָוִד הָמֶלֶךְ עָלָיו הַשָׁלוֹם, יָגֵן עָלֵינוּ וּבַעֲדֵנוּ שֶׁתַאֲרִיךְ אָפְּךָ עַד שׁוּבֵנוּ אֵלָיךָ בִּתְשוּבָה שְׁלֵמָה לְפָנֶיךָ. וּמֵאוֹצָר מַתְנָת חִנָם חָנֵנוּ כְּדִכְתִיב: וְחַנוֹתִי אֶת אֲשֶׁר אָחוֹן וְרִחַמְתִי אֶת אֲשֶׁר אֲרַחֵם.",
  "וּכְשֵׁם שֶׁאָנוּ אוֹמְרִים לְפָנֶיךָ שִׁירָה בָּעוֹלָם הַזֶה, כָּךְ נִזְכֶּה לוֹמַר לְפָנֶיךְ יְיָ אֱלֹהֵינוּ שִׁיר וּשְׁבָחָה לָעוֹלָם הַבָּא. וְעַל יְדֵי אֲמִירַת תְהִלִים תִתְעוֹרֵר חֲבַצֶלֶת הַשָרוֹן, וְלָשִיר בְּקוֹל נָעִים בְּגִילַת וְרַנֵן, כְּבוֹד הַלְבָנוֹן נִתַן לָה, הוֹד וְהָדָר בְּבֵית אֱלֹהֵינוּ, בִּמְהֵרָה בְּיָמֵינוּ, אָמֵן סֶלָה.",
  "לְכוּ נְרַנְּנָה לַיְיָ נָרִיעָה לְצוּר יִשְׁעֵנוּ. נְקַדְּמָה פָנָיו בְּתוֹדָה בִּזְמִרוֹת נָרִיעַ לוֹ. כִּי אֵל גָּדוֹל יְיָ וּמֶלֶךְ גָּדוֹל עַל כָּל אֱלֹהִים. וְאַתָּה קָדוֹשׁ יוֹשֵׁב תְּהִלּוֹת יִשְׂרָאֵל."
];

export const YEHI_RATZON_AFTER = [
  "יְהִי רָצוֹן מִלְפָנֶיךָ יְיָ אֱלֹהֵינוּ וְאֱלֹהֵי אֲבוֹתֵינוּ, שֶׁבִזְכוּת מִזְמוֹרֵי הַתְהִלִים שֶׁקָרָאנוּ לְפָנֶיךָ, וּבִּזְכוּת פְּסוּקֵיהֶם וְתֵבוֹתֵיהֶם, וְאוֹתִיוֹתֵיהֶם וּנְקוּדוֹתֵיהֶם, וְטַעֲמֵיהֶם, וּבִּזְכוּת שְׁמוֹתֶיךָ הַקְדוֹשִׁים וְהַטְהוֹרִים הַיוֹצְאִים מֵהֶם.",
  "שֶׁתְכַפֶּר לָנוּ עַל כָּל חַטֹאתֵינוּ וְתִסְלָח לָנוּ עַל כָּל עֲווֹנוֹתֵינוּ, וְתִמְחַל לָנוּ עַל כָּל פְּשָׁעֵינוּ שֶׁחָטָאנוּ וְשֶעָוִינוּ וְשֶׁפָּשַעְנוּ לְפָנֶיךָ. וְהַחֲזִירֵנוּ בִּתְשוּבָה שְׁלֵמָה לְפָנֶיךָ, וְהַדְרִיכֵנוּ לַעֲבוֹדָתֶךָ וְתִפְתַח לִבֵּנוּ בְּתַלְמוּד תוֹרָתֶךָ.",
  "וְתִשְׁלָח רְפוּאָה שְׁלֵמָה לְחוֹלֵי עַמֶךָ (ולָחולה: לומר את שם החולה ושם אמו). וְתִקְרָא לִשְבוּיִים דְרוֹר וְלַאֲסוּרִים פְּקַח קוֹחַ, וּלְכָל הוֹלְכֵי דְרָכִים וְעוֹבְרֵי יָמִים וּנְהָרוֹת מֵעַמְךָ יִשְׂרָאֵל תַצִילֵם מִכָּל צָעָר וָנֵזֵק, וְתַגִיעֵם לִמְחוֹז חֶפְצָם לְחַיִים וּלְשָׁלוֹם.",
  "וְתִפְקוֹד לְכָל חֲשׂוּכֵי בָּנִים בְּזֶרַע שֶׁל קַיָמָא לַעֲבוֹדָתֶך וּלְיִרְאָתֶךָ. וְעוּבָּרוֹת שֶׁל עַמְךָ בֵּית יִשְׂרָאֵל תַצִילֵן שֶׁלֹא תַפֵּלְנָה וְלָדוֹתֵיהֶן, וְהָיוֹשְבוֹת עַל הַמַשְבֵּר בְּרַחֲמֶיךָ הָרַבִּים תַצִילֵן מִכָּל רָע, וְאֶל הַמֵנִיקוֹת תַשְׁפִּיע שֶׁלֹא יֶחְסַר חָלָב מִדַדֵיהֶן.",
  "וְאַל יִמְשוֹל אַסְכְּרָה וְשֵׁדִין וְרוּחִין וְלִילִין, וְכָל פְּגָעִים וּמַרְעִין בִּישִׁין בְּכָל יַלְדֵי עַמְךָ בֵּית יִשְׂרָאֵל, וּתְגַדְלֵם לְתוֹרָתֶךָ לִלְמוֹד תוֹרָה לִשְׁמָה, וְתַצִילֵם מִעַיִן הָרָע וּמִדֶבֶר וּמִמָגֵפָה וּמִשָׂטָן וּמִיֵצֶר הָרָע.",
  "וּתְבַטֵל מֵעָלֵינוּ וּמִכָּל עַמְךָ בֵּית יִשְׂרָאֵל, בְּכָל מָקוֹם שֶהֵם, כָּל גְזֵרוֹת קָשוֹת וְרָעוֹת, וְתַטֶה לֵב הַמַלְכוּת עָלֵינוּ לְטוֹבָה. וְתִגְזוֹר עָלֵינוּ גְזֵרוֹת טוֹבוֹת, וְתִשְׁלַח בְּרָכָה וְהַצְלָחָה בְּכָל מַעֲשֵׂה יָדֵינוּ, וְהָכֵן פַּרְנָסָתֵינוּ מִיָדְךָ הָרְחָבָה וְהַמְלֵאָה, וְלֹא יִצְטָרְכוּ עַמְךָ בֵּית יִשְׂרָאֵל זֶה לָזֶה וְלֹא לְעַם אַחֵר, וְתֵן לְכָל אִישׁ וָאִישׁ דֵי פַּרְנָסָתוֹ וּלְכָל גְוִיָה וּגְוִיָה דֵי מַחְסוֹרָה.",
  "וּתְמַהֵר וְתָחִישׁ לְגָאֳלֵנוּ וְתִבְנֶה בֵּית מִקְדָשֵׁנוּ וְתִפְאַרְתֵנוּ.",
  "וּבִזְכוּת שְׁלוֹשׁ עֶשְׂרֵה מִידוֹתֶיךָ שֶׁל רַחֲמִים הַכְּתוּבִים בְּתוֹרָתֶךָ כְּמוֹ שֶׁנֶאֱמַר: יְיָ, יְיָ, אֵל רַחוּם וְחַנוּן, אֶרֶךְ אַפַּיִם וְרַב חֶסֶד וֶאֶמֱת, נֹצֵר חֶסֶד לָאֲלָפִים נֹשֵא עָוֹן וָפֶשָׁע וְחַטָאָה וְנַקֵה, שֶׁאֵינָן חוֹזְרוֹת רֵיקָם מִלְפָנֶיךָ, עָזְרֵנוּ אֱלֹהֵי יִשְׁעֵנוּ עַל דְבַר כְּבוֹד שְׁמֶךָ וְהַצִילֵנוּ וְכַפֵּר עַל חַטֹאתֵינוּ לְמַעַן שְׁמֶךָ.",
  "בָּרוּךְ יְיָ לְעוֹלָם אָמֵן וְאָמֵן."
];

export const LILUI_NISHMAT_PRAYER = [
  "יְהִי רָצוֹן מִלְּפָנֶיךָ ה' אֱלֹהֵינוּ וֵאלֹהֵי אֲבוֹתֵינוּ, שֶׁיְּהֵא עֵסֶק הַתְּהִלִּים שֶׁקָּרָאנוּ וּפְסוּקָיו וְאוֹתִיּוֹתָיו וְטַעֲמָיו וְסוֹדוֹתָיו, לְהַעֲלוֹת וּלְקַשֵּׁר אֶת נִשְׁמַת",
  "{{NAME}}",
  "בִּצְרוֹר הַחַיִּים, וְיִנָּפֵשׁ בְּגַן עֵדֶן הַתַּחְתּוֹן וְהָעֶלְיוֹן, וְיִמָּצֵא לוֹ/לָהּ מָנוֹחַ נָכוֹן תַּחַת כַּנְפֵי הַשְּׁכִינָה, וְתַעֲמֹד לוֹ/לָהּ זְכוּת קְרִיאַת הַתְּהִלִּים לְיוֹם הַדִּין, לְהַצְדִּיקוֹ/לְהַצְדִּיקָהּ בַּמִּשְׁפָּט, וְנִזְכֶּה כֻּלָּנוּ לִתְחִיַּת הַמֵּתִים בִּמְהֵרָה בְיָמֵינוּ אָמֵן."
];

type BibleData = {
  Ps?: string[][][];
  [key: string]: any;
};

const RAW_PSALMS: string[][][] = (bible as BibleData).Ps || [];

export const TEHILLIM_TEXT: Record<number, string[]> = {};

RAW_PSALMS.forEach((chapterVerses, index) => {
  const chapterNumber = index + 1;
  TEHILLIM_TEXT[chapterNumber] = chapterVerses.map(wordsArray =>
    (wordsArray || []).join(' ')
  );
});

export function getChaptersRange(start: number, end: number): { chapter: number, verses: string[] }[] {
  const result = [];
  for (let i = start; i <= end; i++) {
    if (TEHILLIM_TEXT[i]) {
      result.push({ chapter: i, verses: TEHILLIM_TEXT[i] });
    }
  }
  return result;
}

// --- Tehillim text via external API (full chapters) ---

export interface TehillimChapter {
  chapter: number;
  verses: string[];
}

const CHAPTER_CACHE_PREFIX = 'tehillim_chapter_';

async function fetchSingleChapterFromApi(chapter: number): Promise<string[]> {
  const cacheKey = `${CHAPTER_CACHE_PREFIX}${chapter}`;

  // Try local cache first
  try {
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      const parsed = JSON.parse(cached);
      if (Array.isArray(parsed) && parsed.length > 0) {
        return parsed;
      }
    }
  } catch {
    // ignore cache errors
  }

  // Prefer local JSON-based text (no external API)
  if (TEHILLIM_TEXT[chapter] && TEHILLIM_TEXT[chapter].length > 0) {
    const verses = TEHILLIM_TEXT[chapter];
    try {
      localStorage.setItem(cacheKey, JSON.stringify(verses));
    } catch {
      // ignore write errors
    }
    return verses;
  }

  // Very small fallback if nothing else worked
  return [
    `מִזְמוֹר לְדָוִד (פרק ${chapter}) — לא ניתן היה לטעון את הטקסט המלא כעת.`
  ];
}

export async function fetchTehillimRange(start: number, end: number): Promise<TehillimChapter[]> {
  const chapters: TehillimChapter[] = [];
  const tasks: Promise<void>[] = [];

  for (let i = start; i <= end; i++) {
    const chap = i;
    tasks.push(
      (async () => {
        const verses = await fetchSingleChapterFromApi(chap);
        chapters.push({ chapter: chap, verses });
      })()
    );
  }

  await Promise.all(tasks);

  // Keep chapters in numeric order
  chapters.sort((a, b) => a.chapter - b.chapter);
  return chapters;
}
